{% extends "layout.html" %}
{% block content %}

<div class="container py-5">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-end mb-4">
        <div>
            <h1 class="fw-bold mb-1">Inventory Intelligence</h1>
            <p class="text-muted mb-0">Real-time overview of global asset distribution and deployment.</p>
        </div>
        <div class="d-none d-md-block">
            <span class="badge bg-light text-dark border px-3 py-2">
                <i class="bi bi-calendar3 me-2"></i>Last Updated: {{ now.strftime('%d %b, %H:%M') if now else 'Just now' }}
            </span>
        </div>
    </div>

    <!-- Key Metrics Ribbon -->
    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="flex-shrink-0 bg-primary bg-opacity-10 text-primary rounded-circle p-2 me-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-box-seam" viewBox="0 0 16 16">
                                <path d="M8.186 1.113a.5.5 0 0 0-.372 0L1.846 3.5l2.404.961L10.404 2l-2.218-.887zm3.564 1.426L5.596 5 8 5.961 14.154 3.5l-2.404-.961zm3.25 1.7-6.5 2.6v7.922l6.5-2.6V4.24zM7.5 14.722V6.828L1 4.24v7.922l6.5 2.6zm-4.787-9.9L7.43 6.603 8.146 6.134 3.443 4.243 2.713 4.822z" />
                            </svg>
                        </div>
                        <h6 class="card-subtitle text-muted fw-normal mb-0">Total Registry</h6>
                    </div>
                    <h2 class="card-title fw-bold mb-0">{{ stats.total_units or 0 }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="flex-shrink-0 bg-success bg-opacity-10 text-success rounded-circle p-2 me-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-building-check" viewBox="0 0 16 16">
                                <path d="M12.5 16a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7m1.679-4.493-1.335 2.226a.75.75 0 0 1-1.174.144l-.774-.773a.5.5 0 0 1 .708-.708l.547.548 1.17-1.951a.5.5 0 1 1 .858.514Z" />
                                <path d="M2 1a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v6.5a.5.5 0 0 1-1 0V1H3v14h3v-2.5a.5.5 0 0 1 .5-.5H8v4H3a1 1 0 0 1-1-1z" />
                                <path d="M4.5 2a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5zm3 0a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5zm3 0a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5z" />
                            </svg>
                        </div>
                        <h6 class="card-subtitle text-muted fw-normal mb-0">Warehouse Stock</h6>
                    </div>
                    <h2 class="card-title fw-bold mb-0 text-success">{{ stats.in_stock or 0 }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="flex-shrink-0 bg-danger bg-opacity-10 text-danger rounded-circle p-2 me-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-people" viewBox="0 0 16 16">
                                <path d="M15 14s1 0 1-1-1-4-5-4-5 3-5 4 1 1 1 1zm-7.978-1L7 12.996c.001-.264.167-1.03.76-1.72C8.312 10.629 9.282 10 11 10c1.717 0 2.687.63 3.24 1.276.593.69.758 1.457.76 1.72l-.008.002-.014.002zM11 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4m3-2a3 3 0 1 1-6 0 3 3 0 0 1 6 0M6.936 9.28a6 6 0 0 0-1.23-.247A7 7 0 0 0 5 9c-4 0-5 3-5 4q0 1 1 1h4.216A2.24 2.24 0 0 1 5 13c0-1.01.377-2.042 1.09-2.904.243-.294.526-.569.846-.816M4.92 10A5.5 5.5 0 0 0 4 13H1c0-.26.164-1.03.76-1.724C2.312 10.629 3.282 10 5 10zm.58-7a2 2 0 1 0 0 4 2 2 0 0 0 0-4m0-1a3 3 0 1 1 0 6 3 3 0 0 1 0-6" />
                            </svg>
                        </div>
                        <h6 class="card-subtitle text-muted fw-normal mb-0">Deployed (Sold)</h6>
                    </div>
                    <h2 class="card-title fw-bold mb-0 text-danger">{{ stats.total_sold or 0 }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="flex-shrink-0 bg-warning bg-opacity-10 text-warning rounded-circle p-2 me-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-tools" viewBox="0 0 16 16">
                                <path d="M1 0 0 1l2.2 3.081a1 1 0 0 0 .815.419h.07a1 1 0 0 1 .708.293l2.675 2.675-2.617 2.654A3.003 3.003 0 0 0 0 13a3 3 0 1 0 5.878-.851l2.654-2.617.968.968-.305.914a1 1 0 0 0 .242 1.023l3.27 3.27a.997.997 0 0 0 1.414 0l1.586-1.586a.997.997 0 0 0 0-1.414l-3.27-3.27a1 1 0 0 0-1.023-.242L10.5 9.5l-.96-.96 2.68-2.683a2.13 2.13 0 0 0 0-3.012l-1.647-1.647a2.13 2.13 0 0 0-3.012 0L4.89 3.89 2.141 1.141A1 1 0 0 0 1.425 1z" />
                            </svg>
                        </div>
                        <h6 class="card-subtitle text-muted fw-normal mb-0">Under Service</h6>
                    </div>
                    <h2 class="card-title fw-bold mb-0 text-dark">{{ stats.in_repair or 0 }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Section: Warehouse Logistics (Internal Stock) -->
    <div class="mb-5">
        <div class="d-flex align-items-center mb-4">
            <div class="bg-dark text-white rounded-circle p-2 me-3" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-geo-alt-fill"></i>
            </div>
            <h3 class="fw-bold mb-0">Internal Logistics</h3>
        </div>

        <div class="row g-4">
            {% for w in warehouses %}
            <div class="col-lg-6">
                <div class="card shadow-sm border-0 h-100 overflow-hidden">
                    <div class="card-header bg-white border-bottom-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="fw-bold mb-0">{{ w.name }}</h5>
                            <span class="text-muted small"><i class="bi bi-pin-map me-1"></i>{{ w.location }}</span>
                        </div>
                        <a href="{{ url_for('view_warehouse', id=w.id) }}" class="btn btn-sm btn-outline-dark rounded-pill px-3">
                            Inventory Management
                        </a>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light text-muted small text-uppercase">
                                    <tr>
                                        <th class="ps-4 border-0 py-3">Fixture Name</th>
                                        <th class="border-0 py-3 text-center">In Stock</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% set ns = namespace(found=false) %}
                                    {% for item in inventory_split %}
                                        {% if item.warehouse_id == w.id %}
                                        {% set ns.found = true %}
                                        <tr>
                                            <td class="ps-4 py-3">
                                                <div class="fw-semibold text-dark">{{ item.fixture_name }}</div>
                                                <div class="text-muted extra-small">{{ item.model_name }}</div>
                                            </td>
                                            <td class="text-center py-3">
                                                <span class="badge bg-light text-dark border fw-bold px-3 py-2" style="min-width: 50px;">
                                                    {{ item.qty }}
                                                </span>
                                            </td>
                                        </tr>
                                        {% endif %}
                                    {% endfor %}

                                    {% if not ns.found %}
                                    <tr>
                                        <td colspan="2" class="text-center py-5">
                                            <div class="text-muted">
                                                <i class="bi bi-box2 d-block fs-2 mb-2 opacity-25"></i>
                                                Currently empty
                                            </div>
                                        </td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Section: Deployed Assets (Sold/Clients) -->
    <div class="mb-5">
        <div class="d-flex align-items-center mb-4">
            <div class="bg-danger text-white rounded-circle p-2 me-3" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-person-check-fill"></i>
            </div>
            <h3 class="fw-bold mb-0">SOLD</h3>
        </div>

        <div class="row g-4">
            {% for c in sold_to_clients %}
            <div class="col-md-6 col-xl-4">
                <div class="card shadow-sm border-0 border-top border-danger border-4 h-100">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h6 class="fw-bold mb-1">{{ c.name }}</h6>
                                <p class="text-muted small mb-0"><i class="bi bi-clock-history me-1"></i>Active Deployment</p>
                            </div>
                            <a href="{{ url_for('view_client', id=c.id) }}" class="btn btn-sm btn-light rounded-circle" title="View Profile">
                                <i class="bi bi-arrow-up-right"></i>
                            </a>
                        </div>

                        <div class="mt-4">
                            {% for sale in sales_split %}
                                {% if sale.client_id == c.id %}
                                <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded-3">
                                    <span class="small fw-medium">{{ sale.fixture_name }}</span>
                                    <span class="badge bg-danger rounded-pill">{{ sale.qty }}</span>
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}

            {% if not sold_to_clients %}
            <div class="col-12">
                <div class="text-center py-5 bg-light rounded-4 border border-dashed">
                    <i class="bi bi-search fs-1 text-muted opacity-25"></i>
                    <p class="mt-3 text-muted">No external deployments found in the active registry.</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Section: Under Maintenance (Under Maintenance) -->
    <!-- <div class="mb-5">
        <div class="d-flex align-items-center mb-4">
            <div class="bg-danger text-white rounded-circle p-2 me-3" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-person-check-fill"></i>
            </div>
            <h3 class="fw-bold mb-0">UNDER MAINTENANCE</h3>
        </div>

        <div class="row g-4">
            {% for c in under_maintenance_clients %}
            <div class="col-md-6 col-xl-4">
                <div class="card shadow-sm border-0 border-top border-danger border-4 h-100">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h6 class="fw-bold mb-1">{{ c.name }}</h6>
                                <p class="text-muted small mb-0"><i class="bi bi-clock-history me-1"></i>Active Deployment</p>
                            </div>
                            <a href="{{ url_for('view_client', id=c.id) }}" class="btn btn-sm btn-light rounded-circle" title="View Profile">
                                <i class="bi bi-arrow-up-right"></i>
                            </a>
                        </div>

                        <div class="mt-4">
                            {% for sale in sales_split %}
                                {% if sale.client_id == c.id %}
                                <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded-3">
                                    <span class="small fw-medium">{{ sale.fixture_name }}</span>
                                    <span class="badge bg-danger rounded-pill">{{ sale.qty }}</span>
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}

            {% if not under_maintenance_clients %}
            <div class="col-12">
                <div class="text-center py-5 bg-light rounded-4 border border-dashed">
                    <i class="bi bi-search fs-1 text-muted opacity-25"></i>
                    <p class="mt-3 text-muted">No clients under maintenance found in the active registry.</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div> -->
</div>
</div>

<style>
    .extra-small {
        font-size: 0.75rem;
    }

    .bg-opacity-10 {
        --bs-bg-opacity: 0.1;
    }

    .border-dashed {
        border-style: dashed !important;
    }

    .card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.08) !important;
    }
</style>

{% endblock %}